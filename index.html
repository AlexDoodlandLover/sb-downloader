<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="referrer" content="no-referrer">
    <title>.sb downloader</title>
    <style>
      main {
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
        width: 480px;
        margin: 24px auto;
      }
      h1 {
        text-align: center;
        font-size: 54px;
      }
      h1, h2 {
        font-weight: normal;
      }
      h1, h2, p {
        margin: 16px 0;
      }
      @media (prefers-color-scheme: dark) {
        :root {
          color-scheme: dark;
          background-color: #111;
          color: #eee;
        }
        a {
          color: #4af;
        }
      }

      :disabled {
        cursor: not-allowed;
      }

      .project-input-outer {
        margin: 16px 0;
        font-size: 24px;
        line-height: 32px;
      }
      .project-input {
        border: none;
        background: transparent;
        font: inherit;
        width: 100%;
        opacity: 0.6;
      }
      .project-input:focus {
        opacity: 1;
      }
      .project-input, .project-input:disabled {
        color: inherit;
      }
      .project-input:disabled {
        opacity: 0.6;
      }

      .download-buttons {
        margin: 16px 0;
        display: flex;
        align-items: center;
        flex-direction: column;
      }
      .download-button {
        color: white;
        border: none;
        padding: 8px 16px;
        font: inherit;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        border-style: solid;
        border-width: 1px;
      }
      .download-button:not(:last-child) {
        margin-bottom: 16px;
      }
      .download-button:hover {
        opacity: 0.9;
      }
      .download-button:active {
        opacity: 0.8;
      }
      .download-button:disabled {
        opacity: 0.5;
      }
      .download-latest-button {
        background: #4C97FF;
        border-color: #237eff;
      }
      .download-legacy-button {
        background-color: #0E9A6C;
        border-color: #0d7d58;
      }
      .download-icon {
        width: 24px;
        height: 24px;
        margin-right: 8px;
        /* Icon from https://fonts.google.com/icons?selected=Material%20Symbols%20Outlined%3Adownload%3AFILL%400%3Bwght%40400%3BGRAD%400%3Bopsz%4048 */
        background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="white" d="M11 40q-1.2 0-2.1-.9Q8 38.2 8 37v-7.15h3V37h26v-7.15h3V37q0 1.2-.9 2.1-.9.9-2.1.9Zm13-7.65-9.65-9.65 2.15-2.15 6 6V8h3v18.55l6-6 2.15 2.15Z"/></svg>');
      }
      .download-button small {
        font-weight: normal;
      }

      .progress-outer {
        margin: 8px 0;
        position: relative;
        width: 100%;
      }
      .progress-inner {
        position: absolute;
        z-index: -1;
        top: 0;
        left: 0;
        width: 0;
        height: 100%;
        background-color: rgba(0, 242, 255, 0.372);
        transition: .2s width, .2s background-color;
      }
      .progress-inner[data-state="done"] {
        background-color: rgba(30, 255, 0, 0.372);
      }
      .progress-inner[data-state="error"] {
        background-color: rgba(255, 0, 0, 0.372);
      }
      .progress-text {
        height: 100%;
        display: flex;
        align-items: center;
        padding: 2px 4px;
        min-height: 35px;
      }

      .downloads-outer {
        margin: 8px 0;
        text-align: center;
      }

      .asset-viewer-outer {
        margin: 16px 0;
        width: 100%;
      }
      .asset-viewer-id {
        width: 100px;
        min-width: 100px;
      }
      td.asset-viewer-id {
        font-size: small;
        text-align: center;
        word-wrap: anywhere;
      }
      .asset-viewer-content {
        width: 100%;
        height: 100%;
      }
      .asset-viewer-content > textarea {
        box-sizing: border-box;
        width: 100%;
        height: 100%;
        min-height: 100px;
      }
      .asset-viewer-content > img {
        max-width: 480px;
        max-height: 360px;
      }
      .asset-viewer-row:hover img {
        outline: 1px solid currentColor;
      }

      .debug-info {
        opacity: 0.8;
        font-size: small;
      }
    </style>
  </head>
  <body>
    <main>
      <h1>.sb downloader</h1>

      <noscript>
        <p>This site requires JavaScript.</p>
      </noscript>

      <p>
        .sb downloader downloads <a href="https://scratch.mit.edu/">Scratch</a> 1, 2, or 3 projects.
        Just paste the project's ID or URL into the input below and press the download button.
      </p>

      <div class="project-input-outer">
        <input class="project-input" value="https://scratch.mit.edu/projects/" spellcheck="false" autocomplete="off">
        <script>
          // The script down below will take a bit to load. We have this separate script so the ID's input
          // will have the correct state immediately.
          window.InitialState = (function() {
            /** @param {HTMLInputElement} el */
            const moveCursorToEnd = (el) => {
              el.selectionStart = el.value.length;
              el.selectionEnd = el.value.length;
            };

            const projectInput = document.querySelector('.project-input');

            const initialUrlParams = new URLSearchParams(location.search);
            const initialProjectId = initialUrlParams.get('id');
            // ?type=sb, ?type=sb2, ?type=sb3 is an old parameter
            const initialType = initialUrlParams.get('type');
            const initialLegacy = initialUrlParams.get('legacy') === 'true';
            if (/^\d+$/.test(initialProjectId)) {
              // We have an initial project ID
              projectInput.value += initialProjectId;
              projectInput.disabled = true;
              const isLegacy = initialLegacy || initialType === 'sb' || initialType === 'sb2';
              return {
                isLegacy
              };
            }

            // No initial project ID
            projectInput.focus();
            moveCursorToEnd(projectInput);
            return null;
          })();
        </script>
      </div>

      <div class="download-buttons">
        <button class="download-button download-latest-button">
          <div class="download-icon"></div>
          <div>Download project</div>
        </button>

        <button class="download-button download-legacy-button">
          <div class="download-icon"></div>
          <div>
            <div>Download legacy version</div>
            <div><small>For pre-2019 projects - read below</small></div>
          </div>
        </button>
      </div>

      <div class="progress-outer" hidden>
        <div class="progress-inner"></div>
        <div class="progress-text"></div>
      </div>

      <div class="downloads-outer"></div>

      <h2>Legacy version of projects</h2>
      <p>
        The "legacy version" of a project is a snapshot of the project's state from just before Scratch 3's release on January 2, 2019.
      </p>
      <p>
        When Scratch 3 was released, existing projects weren't converted to sb3 files.
        However, modifying an existing project will always convert it to an sb3.
        Sometimes this causes issues because the conversion process isn't perfect, which is when downloading the legacy version can be useful.
      </p>

      <h2>Unshared projects</h2>
      <p>
        It's possible that unshared projects will no longer be accessible using this tool in the future due to upcoming Scratch API changes.
        <a href="https://docs.turbowarp.org/unshared-projects">More information</a>.
      </p>

      <h2>Asset viewer</h2>
      <p class="asset-viewer-placeholder">
        Load a project first to use the asset viewer.
      </p>
      <p class="asset-viewer-option-outer">
        <label>
          <input type="checkbox" class="asset-viewer-option" autocomplete="off">
          Enable asset viewer
        </label>
      </p>
      <p class="asset-viewer-not-supported">
        Scratch 1 projects are not supported in the asset viewer.
      </p>
      <table class="asset-viewer-outer" hidden>
        <thead>
          <th class="asset-viewer-id">ID</th>
          <th class="asset-viewer-content">Contents</th>
        </thead>
        <tbody class="asset-viewer-inner">
        </tbody>
      </table>

      <h2>Code</h2>
      <p>
        .sb downloader is <a href="https://github.com/forkphorus/sb-downloader">open source</a>.
      </p>

      <h2>Credits</h2>
      <p>
        .sb downloader is of course powered by the <a href="https://scratch.mit.edu/">Scratch</a> API.
        The <a href="https://stuk.github.io/jszip/">JSZip</a> library is used for creating zip archives.
      </p>

      <h2>Privacy</h2>
      <p>
        In order to access the project token and title, .sb downloader may send the project ID to a server under our control as it can't directly access certain Scratch APIs.
        The ID may be recorded for up to 24 hours for caching purposes only.
      </p>

      <!-- Will be filled in by JS later. Should have something inside so it doesn't cause the page's height to change later. -->
      <p class="debug-info">&nbsp;</p>
    </main>

    <script type="module">
      import JSZip from 'jszip';
      import {downloadProjectFromID, downloadLegacyProjectFromID} from './src/export-web.js';
      import {version} from './package.json';

      /**
       * @param {string} text
       * @returns {string|null}
       */
      const extractProjectId = (text) => {
        const match = text.match(/\d+/);
        if (match) {
          return match[0];
        }
        return null;
      };

      const projectInput = document.querySelector('.project-input');
      const downloadLatestButton = document.querySelector('.download-latest-button');
      const downloadLegacyButton = document.querySelector('.download-legacy-button');
      const progressOuter = document.querySelector('.progress-outer');
      const progressInner = document.querySelector('.progress-inner');
      const progressText = document.querySelector('.progress-text');
      const downloadsOuter = document.querySelector('.downloads-outer');
      const assetViewerPlaceholder = document.querySelector('.asset-viewer-placeholder');
      const assetViewerOptionOuter = document.querySelector('.asset-viewer-option-outer');
      const assetViewerOption = document.querySelector('.asset-viewer-option');
      const assetViewerNotSupported = document.querySelector('.asset-viewer-not-supported');
      const assetViewerOuter = document.querySelector('.asset-viewer-outer');
      const debugInfo = document.querySelector('.debug-info');

      const SCRATCH_PREFIX = 'https://scratch.mit.edu/projects/';
      const PROGRESS_STATE_WORKING = 'working';
      const PROGRESS_STATE_DONE = 'done';
      const PROGRESS_STATE_ERROR = 'error';
      const ASSET_VIEWER_PROJECT_TYPES = ['sb2', 'sb3'];

      projectInput.addEventListener('input', (e) => {
        const projectId = extractProjectId(e.target.value);
        e.target.value = projectId ? `${SCRATCH_PREFIX}${projectId}` : SCRATCH_PREFIX;
      });
      projectInput.addEventListener('focus', (e) => {
        const projectId = extractProjectId(e.target.value);
        if (projectId) {
          e.target.select();
        }
      });

      downloadLatestButton.addEventListener('click', () => {
        downloadProject(false);
      });
      downloadLegacyButton.addEventListener('click', () => {
        downloadProject(true);
      });

      const showAssetViewer = async (project) => {
        const TEXT_EXTENSIONS = ['json'];
        const IMAGE_EXTENSIONS = ['png', 'jpg', 'jpeg', 'gif', 'svg', 'bmp', 'webp'];
        const SOUND_EXTENSIONS = ['mp3', 'wav', 'ogg'];

        removeAssetViewerItems();

        assetViewerOuter.hidden = false;

        const assetViewerInner = document.createElement('tbody');
        assetViewerInner.className = 'asset-viewer-inner';
        assetViewerOuter.appendChild(assetViewerInner);

        const zip = await JSZip.loadAsync(project.arrayBuffer);
        for (const filename of Object.keys(zip.files)) {
          const rowElement = document.createElement('tr');
          rowElement.className = 'asset-viewer-row';
          const idElement = document.createElement('td');
          idElement.textContent = filename;
          idElement.className = 'asset-viewer-id';
          const contentElement = document.createElement('td');
          contentElement.className = 'asset-viewer-content';
          rowElement.appendChild(idElement);
          rowElement.appendChild(contentElement);

          const extension = filename.split('.').pop();

          if (TEXT_EXTENSIONS.includes(extension)) {
            const text = await zip.file(filename).async('text');
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.readOnly = true;
            contentElement.appendChild(textarea);
          } else if (IMAGE_EXTENSIONS.includes(extension)) {
            const base64 = await zip.file(filename).async('base64');
            const type = extension === 'svg' ? 'image/svg+xml' : `image/${extension}`;
            const image = document.createElement('img');
            image.src = `data:${type};base64,${base64}`;
            contentElement.appendChild(image);
          } else if (SOUND_EXTENSIONS.includes(extension)) {
            const base64 = await zip.file(filename).async('base64');
            const audio = document.createElement('audio');
            audio.src = `data:;base64,${base64}`;
            audio.controls = true;
            audio.autoplay = false;
            contentElement.appendChild(audio);
          } else {
            const errorMessage = document.createElement('div');
            errorMessage.textContent = `Unknown extension: ${extension}`;
          }

          assetViewerInner.appendChild(rowElement);
        }
      };
      const removeAssetViewerItems = () => {
        const assetViewerInner = document.querySelector('.asset-viewer-inner');
        if (assetViewerInner) {
          // If the asset viewer is still being created, this won't stop its CPU work, but the result
          // won't be displayed.
          assetViewerInner.remove();
        }
      };
      const resetAssetViewer = () => {
        assetViewerOption.checked = false;
        assetViewerPlaceholder.hidden = false;
        assetViewerOptionOuter.hidden = true;
        assetViewerNotSupported.hidden = true;
        assetViewerOuter.hidden = true;
        removeAssetViewerItems();
      };

      assetViewerOption.addEventListener('change', (e) => {
        if (e.target.checked) {
          showAssetViewer(mostRecentProject);
        } else {
          removeAssetViewerItems();
        }
      });

      const removeDownloadLinks = () => {
        while (downloadsOuter.firstChild) {
          const link = downloadsOuter.firstChild;
          if (link.href) {
            URL.revokeObjectURL(link.href);
          }
          link.remove();
        }
      };

      const setProgress = (text, state, progress) => {
        progressOuter.hidden = false;
        progressInner.style.width = `${10 + progress * 90}%`;
        progressInner.dataset.state = state;
        progressText.textContent = text;
      };
      const resetProgress = () => {
        setProgress('⏳ Downloading project metadata...', PROGRESS_STATE_WORKING, 0);
      };

      const setControlsEnabled = (enabled) => {
        downloadLatestButton.disabled = !enabled;
        downloadLegacyButton.disabled = !enabled;
        projectInput.disabled = !enabled;
      };

      let mostRecentProject = null;

      const downloadProject = async (legacy) => {
        const projectId = extractProjectId(projectInput.value);
        if (!projectId) {
          return;
        }

        try {
          const urlParams = new URLSearchParams(location.search);
          urlParams.set('id', projectId);
          if (legacy) {
            urlParams.set('legacy', 'true');
          } else {
            urlParams.delete('legacy');
          }
          // Remove a legacy parameter
          urlParams.delete('type');
          history.replaceState(null, null, `?${urlParams.toString()}`);

          mostRecentProject = null;
          resetAssetViewer();

          removeDownloadLinks();
          resetProgress();
          setControlsEnabled(false);

          const progressCallback = (type, loaded, total) => {
            let text = type;
            if (type === 'project') {
              text = '⏳ Downloading project data...';
            } else if (type === 'assets') {
              text = `⏳ Downloading assets (${loaded}/${total})...`;
              setProgress()
            } else if (type === 'compress') {
              text = '⏳ Compressing project...';
            }
            setProgress(text, PROGRESS_STATE_WORKING, loaded / total);
          };

          const options = {
            onProgress: progressCallback
          };
          const downloadFunction = legacy ? downloadLegacyProjectFromID : downloadProjectFromID;
          const project = await downloadFunction(projectId, options);
          mostRecentProject = project;

          const title = project.title ? `${project.title} (${projectId})` : projectId;
          const type = project.type;
          const name = `${title}.${type}`;
          const blob = new Blob([project.arrayBuffer]);
          const sizeMB = (blob.size / 1024 / 1024).toFixed(2);
          const url = URL.createObjectURL(blob);

          const downloadElement = document.createElement('a');
          downloadElement.textContent = `Download ${name} (${sizeMB}MB)`;
          downloadElement.download = name;
          downloadElement.href = url;
          downloadsOuter.appendChild(downloadElement);
          downloadElement.click();

          const assetViewerSupported = ASSET_VIEWER_PROJECT_TYPES.includes(type);
          assetViewerPlaceholder.hidden = true;
          assetViewerOptionOuter.hidden = !assetViewerSupported;
          assetViewerNotSupported.hidden = assetViewerSupported;

          setProgress('✅ Done', PROGRESS_STATE_DONE, 1);
        } catch (e) {
          console.error(e);

          let errorMessage = '❌ ';
          if (e && e.name === 'CanNotAccessProjectError') {
            errorMessage += 'The project does not exist or the ID is invalid.'
          } else {
            errorMessage += e;
          }
          setProgress(errorMessage, PROGRESS_STATE_ERROR, 1);
        }

        setControlsEnabled(true);
      };

      debugInfo.textContent = `v${version}`;

      if (window.InitialState) {
        const isLegacy = window.InitialState.isLegacy;
        downloadProject(isLegacy);
      }
    </script>
  </body>
</html>
