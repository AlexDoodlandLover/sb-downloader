<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>.sb downloader 2.0</title>
    <meta name="referrer" content="no-referrer">
    <style>
      main {
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
        width: 480px;
        margin: 24px auto;
      }
      h1 {
        text-align: center;
      }
      @media (prefers-color-scheme: dark) {
        :root {
          color-scheme: dark;
          background-color: #111;
          color: #eee;
        }
        a {
          color: #4af;
        }
      }

      .project-input-outer {
        font-size: 24px;
        line-height: 32px;
      }
      .project-input {
        border: none;
        background: transparent;
        font: inherit;
        width: 100%;
      }

      .progress-outer {
        position: relative;
        top: 0;
        left: 0;
        width: 100%;
        height: 35px;
      }
      .progress-inner {
        position: absolute;
        top: 0;
        left: 0;
        width: 0;
        height: 100%;
        background-color: rgba(0, 242, 255, 0.372);
        transition: .2s width, .2s background-color;
      }
      .progress-inner[data-state="done"] {
        background-color: rgba(30, 255, 0, 0.372);
      }
      .progress-inner[data-state="error"] {
        background-color: rgba(255, 0, 0, 0.372);
      }
      .progress-text {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        margin-left: 4px;
      }
    </style>
  </head>
  <body>
    <main>
      <h1>.sb downloader 2.0</h1>

      <div class="project-input-outer">
        <input class="project-input" value="https://scratch.mit.edu/projects/">
      </div>

      <button class="download-button">
        Download project
      </button>

      <button class="download-legacy-button">
        Download project (legacy)
      </button>

      <div class="progress-outer" hidden>
        <div class="progress-inner"></div>
        <div class="progress-text"></div>
      </div>

      <div class="downloads-outer"></div>

      <h2>Code</h2>
      <p>.sb downloader is <a href="https://github.com/forkphorus/sb-downloader">open source</a>.</p>

      <h2>Credits</h2>
      <p>.sb downloader is of course powered by the <a href="https://scratch.mit.edu/">Scratch</a> API. The <a href="https://stuk.github.io/jszip/">JSZip</a> library is used for creating zip archives.</p>
    </main>

    <script type="module">
      import {downloadProjectFromID, downloadLegacyProjectFromID} from './src/downloader.js';

      /** @param {HTMLInputElement} el */
      const moveCursorToEnd = (el) => {
        el.selectionStart = el.value.length;
        el.selectionEnd = el.value.length;
      };

      /**
       * @param {string} text
       * @returns {string|null}
       */
      const extractProjectId = (text) => {
        const match = text.match(/\d+/);
        if (match) {
          return match[0];
        }
        return null;
      };

      const projectInput = document.querySelector('.project-input');
      const downloadButton = document.querySelector('.download-button');
      const downloadLegacyButton = document.querySelector('.download-legacy-button');
      const progressOuter = document.querySelector('.progress-outer');
      const progressInner = document.querySelector('.progress-inner');
      const progressText = document.querySelector('.progress-text');
      const downloadsOuter = document.querySelector('.downloads-outer');

      const SCRATCH_PREFIX = 'https://scratch.mit.edu/projects/';
      const PROGRESS_STATE_WORKING = 'working';
      const PROGRESS_STATE_DONE = 'done';
      const PROGRESS_STATE_ERROR = 'error';

      projectInput.value = SCRATCH_PREFIX;
      projectInput.focus();
      moveCursorToEnd(projectInput);
      projectInput.addEventListener('input', (e) => {
        const projectId = extractProjectId(e.target.value);
        e.target.value = projectId ? `${SCRATCH_PREFIX}${projectId}` : SCRATCH_PREFIX;
      });

      downloadButton.addEventListener('click', () => {
        downloadProject(false);
      });
      downloadLegacyButton.addEventListener('click', () => {
        downloadProject(true);
      });

      const removeDownloadLinks = () => {
        while (downloadsOuter.firstChild) {
          const link = downloadsOuter.firstChild;
          if (link.href) {
            URL.revokeObjectURL(link.href);
          }
          link.remove();
        }
      };

      const setProgress = (text, state, progress) => {
        progressOuter.hidden = false;
        progressInner.style.width = `${10 + progress * 90}%`;
        progressInner.dataset.state = state;
        progressText.textContent = text;
      };
      const resetProgress = () => {
        setProgress('', PROGRESS_STATE_WORKING, 0);
      };

      const setControlsEnabled = (enabled) => {
        downloadButton.disabled = !enabled;
        downloadLegacyButton.disabled = !enabled;
        projectInput.disabled = !enabled;
      };

      const downloadProject = async (legacy) => {
        const projectId = extractProjectId(projectInput.value);
        if (!projectId) {
          return;
        }

        const urlParams = new URLSearchParams(location.search);
        urlParams.set('id', projectId);
        if (legacy) {
          urlParams.set('legacy', 'true');
        } else {
          urlParams.delete('legacy');
        }
        // Remove a legacy parameter
        urlParams.delete('type');
        history.replaceState(null, null, `?${urlParams.toString()}`);

        try {
          removeDownloadLinks();
          resetProgress();
          setControlsEnabled(false);

          const progressCallback = (type, loaded, total) => {
            let text = type;
            if (type === 'assets') {
              text = `⏳ Downloads assets (${loaded}/${total})...`;
              setProgress()
            } else if (type === 'compress') {
              text = `⏳ Compressing project...`;
            }
            setProgress(text, 'progress', loaded / total);
          };

          const downloadFunction = legacy ? downloadLegacyProjectFromID : downloadProjectFromID;
          const project = await downloadFunction(projectId, progressCallback);

          const type = project.type;
          const blob = new Blob([project.arrayBuffer]);

          const url = URL.createObjectURL(blob);
          const name = `${projectId}.${type}`;
          const sizeMB = Math.round(blob.size / 1024 / 1024 * 100) / 100;
          const downloadElement = document.createElement('a');
          downloadElement.textContent = `Download ${name} (${sizeMB}MB)`;
          downloadElement.download = name;
          downloadElement.href = url;
          downloadsOuter.appendChild(downloadElement);
          downloadElement.click();

          setProgress('✅ Done', PROGRESS_STATE_DONE, 1);
        } catch (e) {
          console.error(e);

          let errorMessage = '❌ ';
          let isUnexpected = false;
          if (e && e.name === 'CanNotAccessProjectError') {
            errorMessage += ' The project is unshared, does not exist, or the ID is invalid.'
          } else {
            isUnexpected = true;
            errorMessage += e;
          }
          setProgress(errorMessage, PROGRESS_STATE_ERROR, 1);

          if (isUnexpected) {
            alert(e);
          }
        }

        setControlsEnabled(true);
      };

      const initialUrlParams = new URLSearchParams(location.search);
      const initialProjectId = initialUrlParams.get('id');
      // ?type=sb, ?type=sb2, ?type=sb3 is a legacy parameter
      const initialType = initialUrlParams.get('type');
      const initialLegacy = initialUrlParams.get('legacy') === 'true';
      if (/^\d+$/.test(initialProjectId)) {
        projectInput.value = `${SCRATCH_PREFIX}${initialProjectId}`;
        if (initialType || initialLegacy) {
          const isLegacy = initialLegacy || initialType === 'sb' || initialType === 'sb2';
          downloadProject(isLegacy);
        }
      }
    </script>
  </body>
</html>
