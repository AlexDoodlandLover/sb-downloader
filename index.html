<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="referrer" content="no-referrer">
    <title>.sb downloader</title>
    <style>
      main {
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
        width: 480px;
        margin: 24px auto;
      }
      h1 {
        text-align: center;
        font-size: 54px;
      }
      h1, h2 {
        font-weight: normal;
      }
      h1, h2, p {
        margin: 16px 0;
      }
      @media (prefers-color-scheme: dark) {
        :root {
          color-scheme: dark;
          background-color: #111;
          color: #eee;
        }
        a {
          color: #4af;
        }
      }

      :disabled {
        cursor: not-allowed;
      }

      .project-input-outer {
        margin: 16px 0;
        font-size: 24px;
        line-height: 32px;
      }
      .project-input {
        border: none;
        background: transparent;
        font: inherit;
        width: 100%;
        opacity: 0.6;
      }
      .project-input:focus {
        opacity: 1;
      }
      .project-input, .project-input:disabled {
        color: inherit;
      }
      .project-input:disabled {
        opacity: 0.6;
      }

      .download-buttons {
        margin: 16px 0;
        display: flex;
        align-items: center;
        flex-direction: column;
      }
      .download-button {
        color: white;
        background: #9966FF;
        border: 1px solid #874bff;
        border: none;
        border-radius: 3px;
        padding: 8px 16px;
        font: inherit;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .download-button:not(:last-child) {
        margin-bottom: 16px;
      }
      .download-button:active {
        opacity: 0.8;
      }
      .download-button:disabled {
        opacity: 0.5;
      }
      .download-legacy-button {
        background-color: #8a55d7;
      }
      .download-button svg {
        width: 24px;
        height: 24px;
        fill: currentColor;
        margin-right: 8px;
      }
      .download-button small {
        font-weight: normal;
      }

      .progress-outer {
        margin: 8px 0;
        position: relative;
        width: 100%;
      }
      .progress-inner {
        position: absolute;
        z-index: -1;
        top: 0;
        left: 0;
        width: 0;
        height: 100%;
        background-color: rgba(0, 242, 255, 0.372);
        transition: .2s width, .2s background-color;
      }
      .progress-inner[data-state="done"] {
        background-color: rgba(30, 255, 0, 0.372);
      }
      .progress-inner[data-state="error"] {
        background-color: rgba(255, 0, 0, 0.372);
      }
      .progress-text {
        height: 100%;
        display: flex;
        align-items: center;
        padding: 2px 4px;
        min-height: 35px;
      }

      .downloads-outer {
        margin: 8px 0;
        text-align: center;
      }

      .debug-info {
        opacity: 0.8;
        font-size: small;
      }
    </style>
  </head>
  <body>
    <main>
      <h1>.sb downloader</h1>

      <noscript>
        <p>This site requires JavaScript.</p>
      </noscript>

      <p>
        .sb downloader downloads <a href="https://scratch.mit.edu/">Scratch</a> 1, 2, or 3 projects.
        Just paste the project's ID or URL into the input below and press the download button.
      </p>

      <div class="project-input-outer">
        <input class="project-input" value="https://scratch.mit.edu/projects/" spellcheck="false" autocomplete="off">
        <script>
          // The script down below will take a bit to load. We have this separate script so the ID's input
          // will have the correct state immediately.
          window.InitialState = (function() {
            /** @param {HTMLInputElement} el */
            const moveCursorToEnd = (el) => {
              el.selectionStart = el.value.length;
              el.selectionEnd = el.value.length;
            };

            const projectInput = document.querySelector('.project-input');

            const initialUrlParams = new URLSearchParams(location.search);
            const initialProjectId = initialUrlParams.get('id');
            // ?type=sb, ?type=sb2, ?type=sb3 is an old parameter
            const initialType = initialUrlParams.get('type');
            const initialLegacy = initialUrlParams.get('legacy') === 'true';
            if (/^\d+$/.test(initialProjectId)) {
              // We have an initial project ID
              projectInput.value += initialProjectId;
              projectInput.disabled = true;
              const isLegacy = initialLegacy || initialType === 'sb' || initialType === 'sb2';
              return {
                isLegacy
              };
            }

            // No initial project ID
            projectInput.focus();
            moveCursorToEnd(projectInput);
            return null;
          })();
        </script>
      </div>

      <div class="download-buttons">
        <button class="download-button download-latest-button">
          <!-- Icon from https://fonts.google.com/icons?selected=Material%20Symbols%20Outlined%3Adownload%3AFILL%400%3Bwght%40400%3BGRAD%400%3Bopsz%4048 -->
          <svg viewBox="0 0 48 48"><path d="M11 40q-1.2 0-2.1-.9Q8 38.2 8 37v-7.15h3V37h26v-7.15h3V37q0 1.2-.9 2.1-.9.9-2.1.9Zm13-7.65-9.65-9.65 2.15-2.15 6 6V8h3v18.55l6-6 2.15 2.15Z"/></svg>
          <div>Download project</div>
        </button>

        <button class="download-button download-legacy-button">
          <!-- Icon from https://fonts.google.com/icons?selected=Material%20Symbols%20Outlined%3Adownload%3AFILL%400%3Bwght%40400%3BGRAD%400%3Bopsz%4048 -->
          <svg viewBox="0 0 48 48"><path d="M11 40q-1.2 0-2.1-.9Q8 38.2 8 37v-7.15h3V37h26v-7.15h3V37q0 1.2-.9 2.1-.9.9-2.1.9Zm13-7.65-9.65-9.65 2.15-2.15 6 6V8h3v18.55l6-6 2.15 2.15Z"/></svg>
          <div>
            <div>Download legacy version</div>
            <div><small>For pre-2019 projects - read below</small></div>
          </div>
        </button>
      </div>

      <div class="progress-outer" hidden>
        <div class="progress-inner"></div>
        <div class="progress-text"></div>
      </div>

      <div class="downloads-outer"></div>

      <h2>Legacy version of projects</h2>
      <p>
        The "legacy version" of a project is a snapshot of the project's state from just before Scratch 3's release on January 2, 2019.
      </p>
      <p>
        When Scratch 3 was released, existing projects weren't converted to sb3 files.
        However, modifying an existing project will always convert it to an sb3.
        Sometimes this causes issues because the conversion process isn't perfect, which is when downloading the legacy version can be useful.
      </p>

      <h2>Unshared projects</h2>
      <p>
        It's possible that unshared projects will no longer be accessible using this tool in the future due to upcoming Scratch API changes.
        <a href="https://docs.turbowarp.org/unshared-projects">More information</a>.
      </p>

      <h2>Code</h2>
      <p>
        .sb downloader is <a href="https://github.com/forkphorus/sb-downloader">open source</a>.
      </p>

      <h2>Credits</h2>
      <p>
        .sb downloader is of course powered by the <a href="https://scratch.mit.edu/">Scratch</a> API.
        The <a href="https://stuk.github.io/jszip/">JSZip</a> library is used for creating zip archives.
      </p>

      <h2>Privacy</h2>
      <p>
        In order to access the project token and title, .sb downloader may send the project ID to a server under our control as it can't directly access certain Scratch APIs.
        The ID may be recorded for up to 24 hours for caching purposes only.
      </p>

      <!-- Will be filled in by JS later. Should have something inside so it doesn't cause the page's height to change later. -->
      <p class="debug-info">&nbsp;</p>
    </main>

    <script type="module">
      import {downloadProjectFromID, downloadLegacyProjectFromID} from './src/export-web.js';
      import {version} from './package.json';

      /**
       * @param {string} text
       * @returns {string|null}
       */
      const extractProjectId = (text) => {
        const match = text.match(/\d+/);
        if (match) {
          return match[0];
        }
        return null;
      };

      const projectInput = document.querySelector('.project-input');
      const downloadLatestButton = document.querySelector('.download-latest-button');
      const downloadLegacyButton = document.querySelector('.download-legacy-button');
      const progressOuter = document.querySelector('.progress-outer');
      const progressInner = document.querySelector('.progress-inner');
      const progressText = document.querySelector('.progress-text');
      const downloadsOuter = document.querySelector('.downloads-outer');
      const debugInfo = document.querySelector('.debug-info');

      const SCRATCH_PREFIX = 'https://scratch.mit.edu/projects/';
      const PROGRESS_STATE_WORKING = 'working';
      const PROGRESS_STATE_DONE = 'done';
      const PROGRESS_STATE_ERROR = 'error';

      projectInput.addEventListener('input', (e) => {
        const projectId = extractProjectId(e.target.value);
        e.target.value = projectId ? `${SCRATCH_PREFIX}${projectId}` : SCRATCH_PREFIX;
      });
      projectInput.addEventListener('focus', (e) => {
        const projectId = extractProjectId(e.target.value);
        if (projectId) {
          e.target.select();
        }
      });

      downloadLatestButton.addEventListener('click', () => {
        downloadProject(false);
      });
      downloadLegacyButton.addEventListener('click', () => {
        downloadProject(true);
      });

      const removeDownloadLinks = () => {
        while (downloadsOuter.firstChild) {
          const link = downloadsOuter.firstChild;
          if (link.href) {
            URL.revokeObjectURL(link.href);
          }
          link.remove();
        }
      };

      const setProgress = (text, state, progress) => {
        progressOuter.hidden = false;
        progressInner.style.width = `${10 + progress * 90}%`;
        progressInner.dataset.state = state;
        progressText.textContent = text;
      };
      const resetProgress = () => {
        setProgress('⏳ Downloading project metadata...', PROGRESS_STATE_WORKING, 0);
      };

      const setControlsEnabled = (enabled) => {
        downloadLatestButton.disabled = !enabled;
        downloadLegacyButton.disabled = !enabled;
        projectInput.disabled = !enabled;
      };

      const downloadProject = async (legacy) => {
        const projectId = extractProjectId(projectInput.value);
        if (!projectId) {
          return;
        }

        const urlParams = new URLSearchParams(location.search);
        urlParams.set('id', projectId);
        if (legacy) {
          urlParams.set('legacy', 'true');
        } else {
          urlParams.delete('legacy');
        }
        // Remove a legacy parameter
        urlParams.delete('type');
        history.replaceState(null, null, `?${urlParams.toString()}`);

        try {
          removeDownloadLinks();
          resetProgress();
          setControlsEnabled(false);

          const progressCallback = (type, loaded, total) => {
            let text = type;
            if (type === 'project') {
              text = '⏳ Downloading project data...';
            } else if (type === 'assets') {
              text = `⏳ Downloading assets (${loaded}/${total})...`;
              setProgress()
            } else if (type === 'compress') {
              text = '⏳ Compressing project...';
            }
            setProgress(text, PROGRESS_STATE_WORKING, loaded / total);
          };

          const options = {
            onProgress: progressCallback
          };
          const downloadFunction = legacy ? downloadLegacyProjectFromID : downloadProjectFromID;
          const project = await downloadFunction(projectId, options);

          const title = project.title ? `${project.title} (${projectId})` : projectId;
          const type = project.type;
          const name = `${title}.${type}`;
          const blob = new Blob([project.arrayBuffer]);
          const sizeMB = (blob.size / 1024 / 1024).toFixed(2);
          const url = URL.createObjectURL(blob);

          const downloadElement = document.createElement('a');
          downloadElement.textContent = `Download ${name} (${sizeMB}MB)`;
          downloadElement.download = name;
          downloadElement.href = url;
          downloadsOuter.appendChild(downloadElement);
          downloadElement.click();

          setProgress('✅ Done', PROGRESS_STATE_DONE, 1);
        } catch (e) {
          console.error(e);

          let errorMessage = '❌ ';
          if (e && e.name === 'CanNotAccessProjectError') {
            errorMessage += 'The project does not exist or the ID is invalid.'
          } else {
            errorMessage += e;
          }
          setProgress(errorMessage, PROGRESS_STATE_ERROR, 1);
        }

        setControlsEnabled(true);
      };

      debugInfo.textContent = `v${version}`;

      if (window.InitialState) {
        const isLegacy = window.InitialState.isLegacy;
        downloadProject(isLegacy);
      }
    </script>
  </body>
</html>
